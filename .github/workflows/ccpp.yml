name: All OS
on:
  push:
    branches: 
      - master
    tags:
      - 'v*.*.*'
jobs:
  build_ubuntu:
    name: Build Ubuntu
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: Prepare
        run: |
          sudo apt-get update -y
          sudo apt-get install cmake libcurl4-openssl-dev libfreetype6-dev libglew-dev libogg-dev libopus-dev libopusfile-dev libpnglite-dev libsdl2-dev libwavpack-dev python -y
          git submodule update --init
      - name: Build Mmo-Clinet Cmake Release mode
        run: |
          mkdir -p release
          cd release
          env cmake ..
          make everything
          ./mmoteeworlds shutdown
          cd ..
      - name: Bundle Zip-Package
        run: |
          zip test_ubuntu.zip release/mmoteeworlds
      - name: Deploy Github Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: Ubuntu-latest
          files: |
            test_ubuntu.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@master
      - name: Prepare
        run: |
          mkdir -p release
          git submodule update --init
      - name: Build
        run: |
          cd release
          env cmake ..
          cmake --config Release --target everything
      - name: Test
        run: |
          Release\mmoteeworlds shutdown
          cd ..
      - name: Bundle Zip-Package
        run: |
          jar -cMf teeworlds_windows32.zip Release\mmoteeworlds.exe
      - name: Deploy Github Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: Windows-latest
          files: |
            teeworlds_windows32.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
